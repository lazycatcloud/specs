# https://www.updatecli.io/docs/core/target/
## 2fauth.yaml
name: Update 2fauth

scms:
  default:
    kind: "github"
    spec:
      owner: "lazycatcloud"
      repository: "specs"
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      user: "zmbots"
      username: 'zmbots'
      email: "devops@zmorg.cn"
      branch: 2fauth
      hidecredit: true
      squash: true
      commitmessage:
        type: "chore"
        scope: "deps"

sources:
  imageVersion:
    name: Get the latest docker image version
    kind: dockerimage
    disablesourceinput: true
    spec:
      image: 2fauth/2fauth
      versionfilter: 
        kind: semver
        pattern: '*'

  currentImageVersion:
    name: Get LPK Image mark
    scmid: default
    kind: yaml
    spec:
      file: lzc-manifest.yml
      key: $.services.service.mark

  copyImageUrl:
    kind: shell
    dependson:
      - 'condition#versionNewer:and'
    disablesourceinput: true
    spec:
      command: |
        set -xe
        npx -y @lazycatcloud/lzc-cli appstore copy-image "2fauth/2fauth:{{ source "imageVersion" }}" --trace-level=quiet
      environments:
        - name: PATH # https://github.com/updatecli/updatecli/blob/045a2956/pkg/plugins/resources/shell/main.go#L98
        - name: HOME
        - name: SHELL
        - name: LANG
        - name: LZC_CLI_TOKEN
          value: {{ requiredEnv "LZC_CLI_TOKEN" }}

  lpkImageUrl:
    name: Get LPK Image URL
    scmid: default
    kind: yaml
    spec:
      file: lzc-manifest.yml
      key: $.services.service.image

  previewVersion:
    name: "Get preview version"
    scmid: default
    kind: yaml
    transformers:
        - semverinc: patch # major / minor / patch
    spec:
      file: lzc-manifest.yml
      key: $.version

conditions:
  versionNewer:
    kind: shell
    disablesourceinput: true
    spec:
      command: |
        set -xe
        current="{{ source "currentImageVersion" }}"
        new="{{ source "imageVersion" }}"
        test -n "$current"
        test -n "$new"
        test "$current" != "$new"

  imageCopySuccess:
    dependson:
      - 'condition#versionNewer:and'
    kind: shell
    disablesourceinput: true
    spec:
      command: |
        set -xe
        test -n "{{ trim (source "copyImageUrl") }}"
        test "{{ source "lpkImageUrl" }}" "!=" "{{ source "copyImageUrl" }}"

targets:
  updateImage:
    name: bump docker image tag
    scmid: default
    kind: yaml
    dependson:
      - 'condition#versionNewer:and'
      - 'condition#imageCopySuccess:and'
    sourceid: copyImageUrl
    spec:
      file: lzc-manifest.yml
      key: $.services.service.image
      quote: false

  updateImageCode:
    name: bump docker image tag code
    scmid: default
    kind: yaml
    dependson:
      - 'condition#versionNewer:and'
      - 'condition#imageCopySuccess:and'
    sourceid: imageVersion
    spec:
      file: lzc-manifest.yml
      key: $.services.service.mark
      quote: false

  updateVersion:
    name: update version in manifest.yml
    scmid: default
    kind: yaml
    dependson:
      - 'condition#versionNewer:and'
      - 'condition#imageCopySuccess:and'
    sourceid: previewVersion
    spec:
      file: lzc-manifest.yml
      key: $.version
      value: '{{ source "previewVersion" }}'

actions:
  default:
    title: '[chore] bump new 2fauth version ðŸ†™'
    kind: github/pullrequest
    scmid: default
    target:
      - updateVersion
    spec:
      automerge: false # the repository needs to enable automatic merge permissions
      maintainercannotmodify: true
      mergemethod: squash
      reviewers: ["PBK-B"]
      labels:
        - dependencies
