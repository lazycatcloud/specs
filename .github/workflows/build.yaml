name: BuildLPK

on:
    # Manually trigger BuildLPK via GitHub UI
    workflow_dispatch:
    # Trigger BuildLPK if a PullRequest is open targeting the main branch.
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
    issue_comment:
        types: [created, edited]
    push:
        tags:
            - "v*.*.*"

permissions:
    contents: "write"
    pull-requests: "write"

jobs:
    buildlpk:
        if: |
            github.event_name == 'pull_request' ||
            (github.event_name == 'push' && 
             github.ref_type == 'tag') ||
            (github.event_name == 'issue_comment' && 
             github.event.issue.pull_request &&
             contains(github.event.comment.body, '/rebuild') &&
             contains(fromJSON('["COLLABORATOR", "MEMBER", "OWNER"]'), github.event.comment.author_association)
            )
        runs-on: "ubuntu-latest"
        env:
            GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
            LZC_CLI_TOKEN: "${{ secrets.LZC_CLI_TOKEN }}"
            LZC_CI_DOCKER_IMAGE: "2fauth/2fauth"
            LZC_CI_LPK_PACKAGE: "cloud.lazycat.app.c2fauth"
            LZC_CI_SVR_IMAGE_TAG_RULE: ".services.service.mark"

        steps:
            - name: Checkout
              uses: actions/checkout@v2
              if: github.event_name != 'push'
              with:
                  # ÂØπ‰∫é issue_comment ‰∫ã‰ª∂ÔºåËé∑Âèñ PR ÁöÑÊúÄÊñ∞ commit
                  ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.sha }}
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Checkout fetch depth all
              uses: actions/checkout@v4
              if: github.event_name == 'push' && github.ref_type == 'tag'
              with:
                  fetch-depth: 0

            - name: Cache node modules
              id: cache-npm
              uses: actions/cache@v4
              env:
                  cache-name: cache-node-modules
              with:
                  # npm cache files are stored in `~/.npm` on Linux/macOS
                  path: ~/.npm
                  key: ${{ runner.os }}-build-${{ env.cache-name }}
                  restore-keys: |
                      ${{ runner.os }}-build-${{ env.cache-name }}

            - name: Install lzc-cli
              run: "npm install -g @lazycatcloud/lzc-cli && npx -y lzc-cli --version"

            - name: Build LPK
              run: "npx -y lzc-cli project build --output ${{ env.LZC_CI_LPK_PACKAGE }}-${{ hashFiles('**/lzc-manifest.yml') }}.lpk"

            - name: "Upload Artifact"
              id: artifact-upload-step
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.LZC_CI_LPK_PACKAGE }}-${{ hashFiles('**/lzc-manifest.yml') }}.lpk
                  path: "**/${{ env.LZC_CI_LPK_PACKAGE }}-**.lpk"
                  retention-days: 5

            - name: Output artifact ID and Url
              run: echo -e "Artifact ID ${{ steps.artifact-upload-step.outputs.artifact-id }}\nUrl ${{ steps.artifact-upload-step.outputs.artifact-url }}\nPR id ${{ github.event.pull_request.id }}"

            - name: Comment PR
              uses: thollander/actions-comment-pull-request@v3
              if: github.event.pull_request != null || github.event.issue.pull_request != null
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  message: |
                      [LPK Build] artifact build ok! :wave:

                      artifact url: <${{ steps.artifact-upload-step.outputs.artifact-url }}>

                      ```sh
                      # install and test
                      lzc-cli app install ${{ env.LZC_CI_LPK_PACKAGE }}-${{ hashFiles('**/lzc-manifest.yml') }}.lpk
                      ```

            - name: Get docker image latest version
              id: image_version
              uses: mikefarah/yq@master
              if: github.event_name == 'push' && github.ref_type == 'tag'
              with:
                  cmd: yq '${{ env.LZC_CI_SVR_IMAGE_TAG_RULE }}' lzc-manifest.yml

            - name: Generate release changelog
              id: changelog_content
              uses: orhun/git-cliff-action@v4
              if: github.event_name == 'push' && github.ref_type == 'tag'
              with:
                  args: --latest --strip header
              env:
                  GITHUB_REPO: ${{ github.repository }}

            - name: Get the pure tag name
              id: lpk_version
              if: github.event_name == 'push' && github.ref_type == 'tag'
              run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT # https://github.blog/changelog/2022-10-11-github-actions-deprecating-save-state-and-set-output-commands/

            - name: Copy Release File
              if: github.event_name == 'push' && github.ref_type == 'tag'
              run: |
                  cp "${{ env.LZC_CI_LPK_PACKAGE }}-${{ hashFiles('**/lzc-manifest.yml') }}.lpk" "${{ env.LZC_CI_LPK_PACKAGE }}-${{ steps.lpk_version.outputs.version }}.lpk"

            - name: Release
              uses: softprops/action-gh-release@v2
              if: github.event_name == 'push' && github.ref_type == 'tag'
              with:
                  draft: false
                  prerelease: false
                  make_latest: true
                  body: "${{ steps.changelog_content.outputs.content }}\n\n### üíº Other\n\n- [update] bump ${{ env.LZC_CI_DOCKER_IMAGE }} docker image ${{ steps.image_version.outputs.result }}"
                  files: |
                      ${{ env.LZC_CI_LPK_PACKAGE }}-${{ steps.lpk_version.outputs.version }}.lpk

        # bin: ÊöÇÊó∂Á¶ÅÁî®Ëá™Âä®ÂèëÂ∏É‰∏äÊû∂ÊµÅÁ®ã
        #   - name: Publish LPK file to appstore
        #     if: github.event_name == 'push' && github.ref_type == 'tag'
        #     run: npx -y lzc-cli appstore publish --changelog "[update] bump ${{ env.LZC_CI_DOCKER_IMAGE }} image v${{ steps.image_version.outputs.result }}" ${{ env.LZC_CI_LPK_PACKAGE }}-${{ hashFiles('**/lzc-manifest.yml') }}.lpk
        #     env:
        #       LC_ALL: zh_CN # lzc-cil https://yargs.js.org/docs/#api-reference-localelocale
